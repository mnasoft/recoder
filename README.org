s#+OPTIONS: ':nil *:t -:t ::t <:t H:3 \n:nil ^:t arch:headline
#+OPTIONS: author:t broken-links:nil c:nil creator:nil
#+OPTIONS: d:(not "LOGBOOK") date:t e:t email:nil f:t inline:t num:t
#+OPTIONS: p:nil pri:nil prop:nil stat:t tags:t tasks:t tex:t
#+OPTIONS: timestamp:t title:t toc:t todo:t |:t
#+TITLE: RECODER
#+DATE: <2019-07-30 Вт>
#+AUTHOR:Nick Matvyeyev
#+EMAIL: mnasoft@gmail.com
#+LANGUAGE: en
#+SELECT_TAGS: export
#+EXCLUDE_TAGS: noexport
#+CREATOR: Emacs 26.1 (Org mode 9.1.9)

* Извлечение данных из тренда  
** Поиск файла тренда в каталоге
#+BEGIN_SRC 
(defun find-trd-by-utime-dirname (utime dir-name &key (extension "trd"))
#+END_SRC
Возвращает объект тренда, для которого существуют данные на момент 
универсального времени utime в каталоге dir-name 
** Аналоговых сигналов

*recoder:trd-analog-by-rec-number*  trd rec-number signal-list

*recoder:trd-analog-by-utime*       trd utime signal-list

*recoder:trd-analog-mid-by-utime*   trd utime signal-list &key (n-before *mid-value-number-offset*) (n-after *mid-value-number-offset*)

*recoder:trd-analog-mid-by-snames*  trd utime snames &key (n-before *mid-value-number-offset*) (n-after *mid-value-number-offset*)

Возвращает список средних значений параметров,записанных в тренде trd в момент времени utime для списка сигналов, определяемых их именами snames.

Осреднение происходит в интервале записей от  n-before до n-after.

*recoder:trd-analog-stddev-by-utime*  trd utime signal-list &key (n-before *mid-value-number-offset*) (n-after *mid-value-number-offset*)

*recoder:trd-analog-stddev-by-snames* trd utime snames      &key (n-before *mid-value-number-offset*) (n-after *mid-value-number-offset*)
*** Пример извлечения сигналов из тренда

#+BEGIN_SRC lisp
    (mnas-format:round-2d-list 
     (math:transpose
      (list 
       (mapcar  #'recoder:a-signal-id *CPIPES-A*)
       (mapcar  #'recoder:a-signal-units *CPIPES-A*)
       (recoder:trd-analog-by-utime  *trd*  *utime* *CPIPES-A*)))))
#+END_SRC


** Извлечение дискретных сигналов
*recoder:trd-discret-by-rec-number*       (trd trd) rec-number d-signal-list

Извлечение дискретных сигналов, заданных списком d-signal-list, из записи с номером rec-number тренда trd в виде 0 или 1.

*recoder:trd-discret-by-rec-number-t-nil* (trd trd) rec-number d-signal-list

Извлечение дискретных сигналов, заданных списком d-signal-list, из записи с номером rec-number тренда trd в виде NIL или T.

*recoder:trd-discret-by-utime*            (trd trd) utime      d-signal-list

Извлечение дискретных сигналов, заданных списком d-signal-list, из записи соответствующей времени utime тренда trd в виде 0 или 1.

*recoder:trd-discret-by-utime-t-nil*      (trd trd) utime      d-signal-list

Извлечение дискретных сигналов, заданных списком d-signal-list, из записи соответствующей времени utime тренда trd в виде NIL или T.

* Формирование списка сигналов из списка имен сигналов 
#+BEGIN_SRC lisp
  (recoder:trd-analog-signal-list *trd* signal-string-list)
#+END_SRC


Возвращает список аналоговых сигналов тренда trd, которые соответствуют списку обозначений сигналов из списка signal-string-list

*recoder:trd-discret-signal-list* (x trd) signal-string-list

Возвращает список дискретных сигналов тренда trd, которые соответствуют списку обозначений сигналов из списка signal-string-list


* Примеры использования  

#+BEGIN_SRC lisp
  (recoder:trd-record-number-by-utime)

  (recoder:trd-analog-by-utime)

  (let ((d-s-l (recoder:trd-discret-signal-list ot-234pm::*trd* '("PH016" "PH017"))))
    (mapcar #'(lambda (ut)
		(recoder:trd-discret-by-utime-t-nil ot-234pm::*trd* ut d-s-l))
	    ot-234pm::*utimes*))
#+END_SRC

#+begin_src lisp
  (progn
    (recoder:trd-analog-ht->org recoder::*trd*)
    (recoder:trd-discret-ht->org recoder::*trd*))
#+end_src

#+RESULTS:
|   0 | FH020 | Дроссельный кран рабочего насоса ДТ - от |
|   1 | FH021 | Дроссельный кран рабочего насоса ДТ - за |
|   2 | FA010 | Кран регулировки подачи ДТ 1-го канала - |
|   3 | FA011 | Кран регулировки подачи ДТ 1-го канала - |
|   4 | FA020 | Кран регулировки подачи ДТ 2-го канала - |
|   5 | FA021 | Кран регулировки подачи ДТ 2-го канала - |
|   6 | FK510 | Кран №41 топливного газа крановой площад |
|   7 | FK511 | Кран №41 топливного газа крановой площад |
|   8 | FK520 | Кран №42 топливного газа крановой площад |
|   9 | FK521 | Кран №42 топливного газа крановой площад |
|  10 | FK530 | Кран №43 топливного газа крановой площад |
|  11 | FK531 | Кран №43 топливного газа крановой площад |
|  12 | FK540 | Кран №46 топливного газа крановой площад |
|  13 | FK541 | Кран №46 топливного газа крановой площад |
|  14 | FA510 | Кран грубой регулировки топливного газа  |
|  15 | FA511 | Кран грубой регулировки топливного газа  |
|  16 | FA520 | Кран грубой регулировки топливного газа  |
|  17 | FA521 | Кран грубой регулировки топливного газа  |
|  18 | FA530 | Кран грубой регулировки топливного газа  |
|  19 | FA531 | Кран грубой регулировки топливного газа  |
|  20 | FA540 | Кран грубой регулировки топливного газа  |
|  21 | FA541 | Кран грубой регулировки топливного газа  |
|  22 | FA550 | Кран тонкой регулировки топливного газа  |
|  23 | FA551 | Кран тонкой регулировки топливного газа  |
|  24 | FA560 | Кран тонкой регулировки топливного газа  |
|  25 | FA561 | Кран тонкой регулировки топливного газа  |
|  26 | FA570 | Кран тонкой регулировки топливного газа  |
|  27 | FA571 | Кран тонкой регулировки топливного газа  |
|  28 | FA580 | Кран тонкой регулировки топливного газа  |
|  29 | FA581 | Кран тонкой регулировки топливного газа  |
|  30 | NJ010 | Загазованность бокса 9  - порог 0.5%     |
|  31 | NJ020 | Загазованность бокса 9 - порог 1%        |
|  32 | PH030 | Задвижка технологического воздуха левой  |
|  33 | PH031 | Задвижка технологического воздуха левой  |
|  34 | PH040 | Задвижка технологического воздуха правой |
|  35 | PH041 | Задвижка технологического воздуха правой |
|  36 | FH026 | Дроссельный кран рабочего насоса ДТ - от |
|  37 | FH027 | Дроссельный кран рабочего насоса ДТ - за |
|  38 | FA016 | Кран регулировки подачи жидкого топлива  |
|  39 | FA017 | Кран регулировки подачи жидкого топлива  |
|  40 | FA026 | Кран регулировки подачи жидкого топлива  |
|  41 | FA027 | Кран регулировки подачи жидкого топлива  |
|  42 | FR017 | Агрегат зажигания - отключить            |
|  43 | FR016 | Агрегат зажигания - включить             |
|  44 | FR018 | Клапан пускового газа                    |
|  45 | FK516 | Кран №41 топливного газа крановой площад |
|  46 | FK517 | Кран №41 топливного газа крановой площад |
|  47 | FK526 | Кран №42 топливного газа крановой площад |
|  48 | FK527 | Кран №42 топливного газа крановой площад |
|  49 | FK536 | Кран №43 топливного газа крановой площад |
|  50 | FK537 | Кран №43 топливного газа крановой площад |
|  51 | FK546 | Кран №46 топливного газа крановой площад |
|  52 | FK547 | Кран №46 топливного газа крановой площад |
|  53 | FA516 | Кран грубой регулировки топливного газа  |
|  54 | FA517 | Кран грубой регулировки топливного газа  |
|  55 | FA526 | Кран грубой регулировки топливного газа  |
|  56 | FA527 | Кран грубой регулировки топливного газа  |
|  57 | FA536 | Кран грубой регулировки топливного газа  |
|  58 | FA537 | Кран грубой регулировки топливного газа  |
|  59 | FA546 | Кран грубой регулировки топливного газа  |
|  60 | FA547 | Кран грубой регулировки топливного газа  |
|  61 | FA556 | Кран тонкой регулировки топливного газа  |
|  62 | FA557 | Кран тонкой регулировки топливного газа  |
|  63 | FA566 | Кран тонкой регулировки топливного газа  |
|  64 | FA567 | Кран тонкой регулировки топливного газа  |
|  65 | FA576 | Кран тонкой регулировки топливного газа  |
|  66 | FA577 | Кран тонкой регулировки топливного газа  |
|  67 | FA586 | Кран тонкой регулировки топливного газа  |
|  68 | FA587 | Кран тонкой регулировки топливного газа  |
|  69 | FR010 | Агрегат зажигания - включен              |
|  70 | FR011 | Агрегат зажигания - отключен             |
|  71 | PH036 | Задвижка технологического воздуха левой  |
|  72 | PH037 | Задвижка технологического воздуха левой  |
|  73 | PH046 | Задвижка технологического воздуха правой |
|  74 | PH047 | Задвижка технологического воздуха правой |
|  75 | PM016 | Аварийная вентиляция - включить          |
|  76 | NJ030 | Загазованность бокса 9 - отказ           |
|  77 | FH036 | Клапан слива 1-го канала                 |
|  78 | FH046 | Клапан слива 2 -го канала                |
|  79 | GAS   | Газообразное топливо                     |
|  80 | OIL   | Жидкое топливо                           |
|  81 | FM010 | Топливный насос - включен                |
|  82 | FM011 | Топливный насос - отключен               |
|  83 | VM010 | Насос воды - включен                     |
|  84 | VM011 | Насос воды - отключен                    |
|  85 | PH010 | Кран регулировки подачи техн. воздуха -  |
|  86 | PH011 | Кран регулировки подачи техн. воздуха -  |
|  87 | VH010 | Кран регулировки подачи питьевой воды -  |
|  88 | VH011 | Кран регулировки подачи питьевой воды -  |
|  89 | FM016 | Рабочий насос ДТ - включить              |
|  90 | FM017 | Рабочий насос ДТ - отключить             |
|  91 | VM016 | Насос воды - включить                    |
|  92 | VM017 | Насос воды - отключить                   |
|  93 | PH016 | Кран регулировки подачи технического воз |
|  94 | PH017 | Кран регулировки подачи технического воз |
|  95 | VH016 | Кран регулировки подачи воды - открыть   |
|  96 | VH017 | Кран регулировки подачи воды - закрыть   |
|  97 | VH026 | Кран перепуска воды - открыть            |
|  98 | VH027 | Кран перепуска воды - закрыть            |
|  99 | FH010 | Кран подачи ДТ - открыт                  |
| 100 | FH011 | Кран подачи ДТ - закрыт                  |

